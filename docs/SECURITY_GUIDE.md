# GMTools 安全防护指南

## 🔒 安全问题概述

### 您提出的问题非常关键！

**问题**：前端明文发送数据是否会被篡改？
**答案**：是的，**前端数据完全可以被篡改**！

任何有经验的用户都可以：
1. 打开浏览器开发者工具（F12）
2. 修改 JavaScript 代码
3. 篡改发送给服务器的参数
4. 例如：将道具数量从 1 改成 999999

## ⚠️ 已识别的安全风险

### 1. **参数篡改风险**
- ❌ 道具数量可被任意修改
- ❌ 宝石等级可被任意修改
- ❌ 角色属性可被任意修改
- ❌ 充值金额可被任意修改

### 2. **缺少验证机制**
- ❌ 后端未验证参数合法性
- ❌ 未设置数量上限
- ❌ 未记录敏感操作日志
- ❌ 未限制操作频率

## 🛡️ 已实施的安全加固

### 1. **后端参数验证**（✅ 已实现）

创建了 `config/security_config.py`，定义了：

#### 道具数量限制
```python
ITEM_LIMITS = {
    "default": {
        "min": 1,
        "max": 999,          # 单次最多999个
        "daily_max": 9999    # 每日最多9999个
    },
    "rare_items": {          # 稀有道具
        "min": 1,
        "max": 10,
        "daily_max": 50
    },
    "currency": {            # 货币类
        "min": 1,
        "max": 100000000,
        "daily_max": 1000000000
    }
}
```

#### 宝石等级限制
```python
GEM_LEVEL_LIMITS = {
    "min_level": 1,
    "max_level": 15  # 最高15级
}
```

#### 角色属性限制
```python
CHARACTER_ATTR_LIMITS = {
    "level": {"min": 1, "max": 200},
    "hp": {"min": 1, "max": 999999},
    "attack": {"min": 1, "max": 9999},
    # ...
}
```

### 2. **服务层验证**（✅ 已实现）

修改了 `services/gift_service.py`，添加了：

```python
def give_item(self, player_id: str, item_name: str, count: int = 1, 
              item_category: str = "default") -> bool:
    # 验证数量
    is_valid, error_msg = SecurityConfig.validate_item_count(count, item_category)
    if not is_valid:
        logger.warning(f"道具数量验证失败: {error_msg}")
        raise ValueError(f"参数验证失败: {error_msg}")
    
    # 记录敏感操作
    logger.info(f"[GIFT] 给予道具 - 玩家: {player_id}, 道具: {item_name}, 数量: {count}")
    
    # ... 执行操作
```

### 3. **操作日志记录**（✅ 已实现）

所有敏感操作都会记录：
- 操作时间
- 操作用户
- 操作对象（玩家ID）
- 操作内容（道具名称、数量等）
- 操作结果

## 🔐 多层防护体系

### 第一层：JWT Token 认证
```
前端请求 → 验证 Token → 验证用户权限 → 允许/拒绝
```

### 第二层：参数验证
```
接收参数 → 验证范围 → 验证类型 → 验证逻辑 → 允许/拒绝
```

### 第三层：操作日志
```
执行操作 → 记录日志 → 审计追踪 → 异常告警
```

### 第四层：频率限制（建议实施）
```
统计操作 → 检查频率 → 超限拒绝 → 记录告警
```

## 📝 安全最佳实践

### ✅ DO（应该做的）

1. **永远不要信任前端数据**
   - 所有参数都必须在后端验证
   - 设置合理的上下限
   - 验证数据类型和格式

2. **记录所有敏感操作**
   - 谁做的（用户ID）
   - 什么时候做的（时间戳）
   - 做了什么（操作详情）
   - 结果如何（成功/失败）

3. **实施多层防护**
   - 认证层：验证身份
   - 授权层：验证权限
   - 验证层：验证参数
   - 审计层：记录日志

4. **定期审计日志**
   - 检查异常操作
   - 发现可疑行为
   - 及时处理问题

### ❌ DON'T（不应该做的）

1. **不要依赖前端验证**
   - 前端验证只是用户体验优化
   - 后端必须再次验证

2. **不要使用硬编码的限制**
   - 使用配置文件
   - 便于调整和维护

3. **不要忽略日志**
   - 日志是发现问题的关键
   - 定期检查和分析

## 🎯 攻击场景示例

### 场景 1：道具数量篡改

**攻击者操作**：
```javascript
// 在浏览器控制台执行
fetch('/api/gift/item', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        player_id: '123456',
        item_name: '神器',
        count: 999999  // 篡改数量
    })
})
```

**防护措施**：
```python
# 后端验证
if count > 999:
    raise ValueError("单次数量不能超过 999")
```

### 场景 2：宝石等级篡改

**攻击者操作**：
```javascript
// 修改宝石等级为999级
{
    gem_name: '顶级宝石',
    min_level: 999,  // 篡改
    max_level: 999   // 篡改
}
```

**防护措施**：
```python
# 后端验证
if max_level > 15:
    raise ValueError("宝石等级不能超过 15")
```

## 📊 安全检查清单

在实施任何游戏操作前，请确认：

- [ ] 是否有 JWT Token 认证？
- [ ] 是否验证了用户权限？
- [ ] 是否验证了参数范围？
- [ ] 是否记录了操作日志？
- [ ] 是否有频率限制？
- [ ] 是否有异常告警？

## 🚀 后续改进建议

### 1. **实施频率限制**
使用 Redis 或内存缓存记录操作频率：
```python
# 每分钟最多30次给予道具操作
if operation_count_per_minute > 30:
    raise TooManyRequestsError()
```

### 2. **添加二次确认**
对于敏感操作（如大量充值），要求：
- 输入验证码
- 管理员审批
- 延迟执行

### 3. **实施 IP 白名单**
只允许特定 IP 访问管理接口：
```python
ALLOWED_IPS = ['192.168.1.100', '10.0.0.1']
```

### 4. **添加操作审批流程**
重要操作需要多人审批：
- 发起人提交申请
- 审批人审核
- 系统执行

## 📞 总结

**您的担心是完全正确的！**

前端数据**必须**在后端进行严格验证。我已经为您实施了：

1. ✅ **参数验证框架**（`security_config.py`）
2. ✅ **服务层验证**（`gift_service.py`）
3. ✅ **操作日志记录**
4. ✅ **错误处理机制**

**下一步建议**：
- 根据实际业务调整限制值
- 实施频率限制
- 定期审计日志
- 监控异常行为

**记住**：在安全方面，永远不要信任前端！🔒
